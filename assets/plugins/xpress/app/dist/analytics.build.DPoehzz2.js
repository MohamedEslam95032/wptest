class h{constructor(){this.config={endpoint:"/wp-json/uixpress/v1/analytics/track",batchSize:5,flushInterval:3e4,maxRetries:3,retryDelay:1e3,alwaysUseKeepalive:!0},this.queue=[],this.isInitialized=!1,this.sessionId=this.getOrCreateSessionId(),this.lastTrackTime=0,this.minTrackInterval=1e3,this.isProcessingUnload=!1,window.uixpressAnalytics=this,this.init()}init(){this.shouldTrack()&&(this.isInitialized=!0,this.trackPageView(),this.setupEventListeners(),this.startBatchProcessor(),this.trackVisibilityChanges(),this.trackNavigationChanges())}shouldTrack(){return window.location.href.includes("/wp-admin/")?!1:this.isAnalyticsEnabled()}isAnalyticsEnabled(){return!0}getOrCreateSessionId(){let e=sessionStorage.getItem("uixp_analytics_session");return e||(e=this.generateId(),sessionStorage.setItem("uixp_analytics_session",e)),e}generateId(){return Math.random().toString(36).substr(2,9)+Date.now().toString(36)}trackPageView(){const e=Date.now();if(e-this.lastTrackTime<this.minTrackInterval)return;this.lastTrackTime=e;const t={page_url:window.location.href,page_title:document.title,referrer:document.referrer||null,user_agent:navigator.userAgent,timestamp:e};this.queue.push(t)}setupEventListeners(){document.addEventListener("click",e=>{const t=e.target.closest("a");t&&this.isExternalLink(t.href)&&this.trackClick(t.href,"external_link")}),document.addEventListener("submit",e=>{const t=e.target;t.tagName==="FORM"&&!t.action.includes("/wp-admin/")&&this.trackFormSubmission(t)}),this.trackTimeOnPage()}trackClick(e,t="click"){const s={page_url:e,page_title:document.title,referrer:window.location.href,event_type:t,timestamp:Date.now()};this.queue.push(s)}trackFormSubmission(e){const t=e.action||"unknown",s=e.method||"POST",i={page_url:t,page_title:document.title,referrer:window.location.href,event_type:"form_submission",form_method:s,timestamp:Date.now()};this.queue.push(i)}trackTimeOnPage(){const e=Date.now();window.addEventListener("beforeunload",()=>{const t=Date.now()-e;t>1e3&&this.trackTimeOnPageEvent(t)})}trackTimeOnPageEvent(e){const t={page_url:window.location.href,page_title:document.title,referrer:document.referrer||null,event_type:"time_on_page",time_on_page:e,timestamp:Date.now()};this.queue.push(t)}trackNavigationChanges(){window.addEventListener("popstate",()=>{setTimeout(()=>{this.trackPageView()},100)});const e=history.pushState,t=history.replaceState;history.pushState=function(...s){e.apply(history,s),setTimeout(()=>{this.trackPageView()},100)},history.replaceState=function(...s){t.apply(history,s),setTimeout(()=>{this.trackPageView()},100)}}isExternalLink(e){try{const t=new URL(e),s=new URL(window.location.href);return t.hostname!==s.hostname}catch{return!1}}throttle(e,t){let s,i=0;return function(...a){const n=Date.now();n-i>t?(e.apply(this,a),i=n):(clearTimeout(s),s=setTimeout(()=>{e.apply(this,a),i=Date.now()},t-(n-i)))}}trackVisibilityChanges(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&this.trackPageView()})}startBatchProcessor(){this.processQueue(),setInterval(()=>{this.processQueue()},this.config.flushInterval),this.setupUnloadHandlers()}setupUnloadHandlers(){window.addEventListener("beforeunload",()=>{this.processQueue(!0)}),window.addEventListener("pagehide",()=>{this.processQueue(!0)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.processQueue(!0)});const e=history.pushState,t=history.replaceState;history.pushState=function(...s){window.uixpressAnalytics&&window.uixpressAnalytics.processQueue(!0),e.apply(history,s)},history.replaceState=function(...s){window.uixpressAnalytics&&window.uixpressAnalytics.processQueue(!0),t.apply(history,s)}}async processQueue(e=!1){if(this.queue.length===0||(console.log("Processing queue",this.queue),e&&this.isProcessingUnload))return;e&&(this.isProcessingUnload=!0);const t=e?this.queue.length:this.config.batchSize,s=this.queue.splice(0,t);if(e){const i=s.map(n=>this.sendEvent(n,!0));(await Promise.allSettled(i)).forEach((n,r)=>{n.status==="rejected"&&console.warn("UiXpress Analytics: Failed to send unload event",n.reason)})}else for(const i of s)try{await this.sendEvent(i)}catch(a){console.warn("UiXpress Analytics: Failed to send event",a),i.retryCount<this.config.maxRetries&&(i.retryCount=(i.retryCount||0)+1,this.queue.unshift(i))}}async sendEvent(e,t=!1){var u,l;const s=((u=window.wpApiSettings)==null?void 0:u.root)||"/wp-json/",i=((l=window.wpApiSettings)==null?void 0:l.nonce)||this.getNonceFromMeta(),a={page_url:e.page_url,session_id:this.sessionId};e.page_title&&(a.page_title=e.page_title),e.referrer&&(a.referrer=e.referrer),e.user_agent&&(a.user_agent=e.user_agent);const n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)};i&&(n.headers["X-WP-Nonce"]=i),(t||this.config.alwaysUseKeepalive)&&(n.keepalive=!0);const r=await fetch(`${s}uixpress/v1/analytics/track`,n);if(!r.ok){let c=`HTTP ${r.status}: ${r.statusText}`;try{const o=await r.json();o.message?c=o.message:o.code&&(c=`${o.code}: ${o.message||r.statusText}`)}catch{}throw console.error("UiXpress Analytics: Failed to send event",c,a),new Error(c)}return r.json()}getNonceFromMeta(){const e=document.querySelector('meta[name="wp-api-nonce"]');return e?e.getAttribute("content"):null}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new h}):new h;
//# sourceMappingURL=analytics.build.DPoehzz2.js.map
